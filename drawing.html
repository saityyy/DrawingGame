<!DOCTYPE html>
<html lang="ja">

    <head>
        <meta charset="utf-8">
        <title>drawing</title>
    </head>

    <body>
        <h2>二等分線を引け</h2>
        <div id="stage" style="width:900px;height:600px;border:solid 1px #000"></div>
        <div id=correctJudge>
            <input type="button" value="正誤判定" onclick="judge()">
            <p id=result></p>
        </div>
        <input type="button" value="一つ前に戻る" onclick="r()">
        <input type="button" value="ターン交代" onclick="c()">
        <script src="https://cdn.anychart.com/js/latest/graphics.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
        <script src="drawing.js"></script>
        <script>
            function judge(linesAns, circlesAns) {
                var correct;
                console.log(drawLines);
                console.log(drawCircles);
                correct = linesAns.every(function lines_check(ans) {
                    //(startX,startY,grad,length)
                    ans = [
                        ans[0],
                        ans[1],
                        (ans[3] - ans[1]) / (ans[2] - ans[0]),
                        dist(ans[0] - ans[2], ans[1] - ans[3])
                    ];
                    var flag2 = this.drawLines.some(function line_check(inp) {
                        inp = [
                            inp[0],
                            inp[1],
                            (inp[3] - inp[1]) / (inp[2] - inp[0]),
                            dist(inp[0] - inp[2], inp[1] - inp[3])];
                        Draw.judgeLine(inp, ans);
                    });
                    return flag2;
                });
                correct = correct && this.circlesAns.every(function circles_check(ans) {
                    var flag2 = drawCircles.some(function circle_check(inp) {
                        return Draw.judgeCircle(inp, ans);
                    });
                    return flag2;
                })
                return correct;
            }
            function draw() {
                Draw.drawLines.forEach(function (xy) {
                    Draw.Line(xy);
                });
                Draw.drawCircles.forEach(function (xy) {
                    Draw.Circle(xy);
                })
            }
            var turn_flag = true;
            var stage = acgraph.create('stage');
            var Draw = new drawing(stage);
            var xhr = new XMLHttpRequest();
            xhr.open('POST', 'draw.php', true);
            xhr.responseType = 'json';
            xhr.setRequestHeader('content-type',
                'application/x-www-form-urlencoded;charset=UTF-8');
            var json = JSON.stringify({ "reqText": "iniset" });
            console.log(json);
            xhr.send("request=" + encodeURIComponent(json));
            xhr.onreadystatechange = function () {
                if (xhr.status == 200 && xhr.readyState == 4) {
                    var res = xhr.response;
                    console.log(res["resText"]);
                    if (res["resText"] == "iniset") {
                        Draw.setData(res);
                        console.log(Draw.drawLines);
                        draw();
                    }
                }
            };
            var conn = new WebSocket('ws://localhost:80');
            var ws_flag = false;
            conn.onopen = function (e) {
                console.log("connection for comment established!");
                ws_flag = true;
            };
            conn.onmessage = function (e) {
                if (e.data == partnerID) {
                    console.log(e.data);
                    turn_flag = true;
                }
            };
            //var conn = new WebSocket('ws://localhost:80');

            function c() {
                if (ws_flag) {
                    turn_flag = false;
                    conn.send(id);
                }
            }

            function dist(dx, dy) {
                return parseInt(Math.sqrt(dx * dx + dy * dy));
            }

            function r() {
                var s = draw_stack.pop();
                if (s == 1) drawLines.pop();
                else if (s == 0) drawCircles.pop();
                stage.rect(0, 0, 900, 600).fill('white');
                draw(drawLines, drawCircles);
            }

            $('#stage').on('mousemove', function (e) {
                stage.rect(0, 0, 900, 600).fill('white');
                Draw.mouseMove(clickX, clickY, e.offsetX, e.offsetY);
                draw();
            });
            $('#stage').on('click', function (e) {
                Draw.mouseClick(e.offsetX, e.offsetY);
            });
        </script>
    </body>

</html>